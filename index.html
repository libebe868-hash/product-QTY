<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>三诚螺纹护套实时库存大屏</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>三诚螺纹护套实时库存大屏</h1>
      <div class="update-time" id="updateTime">加载中...</div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="overview">总览大屏</button>
      <button class="tab" data-tab="ranking">库存排行榜</button>
      <button class="tab" data-tab="detail">型号明细查询</button>
    </div>

    <div id="overview" class="panel active">
      <div class="grid">
        <div class="card total"><div class="num" id="totalItems">-</div><div class="label">总SKU数</div></div>
        <div class="card total"><div class="num" id="totalStock">-</div><div class="label">总库存件数</div></div>
        <div class="card total"><div class="num" id="totalTypes">-</div><div class="label">总型号数</div></div>
        <div class="card total"><div class="num" id="activeTypes">-</div><div class="label">有库存型号</div></div>
      </div>
      <div class="charts">
        <div class="chart-box"><h3>各型号库存占比</h3><div id="pieChart" style="height:400px;"></div></div>
        <div class="chart-box"><h3>库存Top15规格</h3><div id="barChart" style="height:400px;"></div></div>
      </div>
    </div>

    <div id="ranking" class="panel">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="搜索型号或规格（如：302、M6、1215黄铜）">
        <button id="exportBtn">导出CSV</button>
      </div>
      <div id="rankingList"></div>
    </div>

    <div id="detail" class="panel">
      <div style="margin-bottom:15px;">
        <select id="sheetSelect"></select>
        <span style="margin-left:20px;color:#aaa;">共 <span id="itemCount">0</span> 条规格</span>
      </div>
      <div class="search-bar">
        <input type="text" id="detailSearch" placeholder="智能搜索：M3 → M3*0.5 → M3*0.5-L6（逐步精准）">
        <button id="detailExportBtn">导出当前型号</button>
      </div>
      <table id="detailTable">
        <thead><tr><th>序号</th><th>型号</th><th>规格</th><th>材质</th><th>现库存</th><th>单位</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let allData = {};
    let currentSheetData = [];

    function safeSetText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    async function loadData() {
      try {
        // 极速加载：直接从 jsDelivr CDN（中国节点）拉 JSON
        const resp = await fetch('https://cdn.jsdelivr.net/gh/libebe868-hash/product-QTY@latest/inventory-data.json?t=' + Date.now());
        if (!resp.ok) throw new Error("JSON 未找到");
        
        allData = await resp.json();
        safeSetText('updateTime', "数据更新时间: " + new Date().toLocaleString('zh-CN'));
        renderAll();
        console.log("数据加载成功（极速模式）");
      } catch (e) {
        safeSetText('updateTime', "加载失败，请检查网络或联系管理员");
        console.error(e);
      }
    }

    function renderAll() {
      const allItems = Object.values(allData).flat();
      const hasStock = allItems.filter(i => i.stock > 0);
      
      safeSetText('totalItems', hasStock.length.toLocaleString());
      safeSetText('totalStock', hasStock.reduce((s,i)=>s+i.stock,0).toLocaleString());
      safeSetText('totalTypes', Object.keys(allData).length);
      safeSetText('activeTypes', Object.keys(allData).filter(k => allData[k].some(i=>i.stock>0)).length);

      renderPieChart();
      renderBarChart();
      renderRanking();
      renderTypeSelect();
    }

    function renderPieChart() {
      const map = {};
      Object.values(allData).flat().forEach(i => {
        if (i.stock > 0) map[i.type] = (map[i.type]||0) + i.stock;
      });
      const data = Object.entries(map).map(([k,v]) => ({name:k,value:v}));
      echarts.init(document.getElementById("pieChart")).setOption({
        tooltip:{trigger:'item'},legend:{orient:'vertical',right:10,top:'center',textStyle:{color:'#fff'}},
        series:[{type:'pie',radius:['30%','70%'],center:['40%','50%'],data}]
      });
    }

    function renderBarChart() {
      const top15 = Object.values(allData).flat().filter(i=>i.stock>0).sort((a,b)=>b.stock-a.stock).slice(0,15);
      const labels = top15.map(i=>i.spec.length>20?i.spec.slice(0,20)+'...':i.spec);
      echarts.init(document.getElementById("barChart")).setOption({
        tooltip:{trigger:'axis'},grid:{left:60,right:20,top:40,bottom:60},
        xAxis:{type:'value',axisLabel:{color:'#ccc'}},
        yAxis:{type:'category',data:labels,axisLabel:{color:'#fff'}},
        series:[{type:'bar',data:top15.map(i=>({value:i.stock,itemStyle:{color:i.stock<1000?'#ff4444':'#00d4ff'}})),label:{show:true,position:'right',color:'#fff'}}]
      });
    }

    function renderRanking(items=null) {
      let list = items || Object.values(allData).flat().filter(i=>i.stock>0).sort((a,b)=>b.stock-a.stock);
      document.getElementById("rankingList").innerHTML = list.slice(0,100).map((i,idx)=>`
        <div class="rank-item ${idx<3?'top3':''} ${i.stock<1000?'low-stock':''}">
          <span class="rank-num">${idx+1}</span>
          <span class="type ${idx<3?'top3-text':''}">${i.type}</span>
          <span class="spec ${idx<3?'top3-text':''}">${i.spec}</span>
          <span class="material ${idx<3?'top3-text':''}">${i.material||'-'}</span>
          <span class="stock ${idx<3?'top3-text':''}">${i.stock.toLocaleString()}${i.stock<1000?' 低库存':''}</span>
        </div>`).join('');
    }

    function renderTypeSelect() {
      const s = document.getElementById("sheetSelect");
      const keys = Object.keys(allData).sort();
      s.innerHTML = keys.map(k=>`<option value="${k}">${k}（${allData[k].length}规格）</option>`).join('');
      s.onchange = () => { currentSheetData = allData[s.value]; renderDetailTable(currentSheetData); };
      currentSheetData = allData[keys[0]];
      renderDetailTable(currentSheetData);
    }

    function renderDetailTable(data, kw='') {
      let filtered = kw ? data.filter(i=>i.spec.toUpperCase().includes(kw.toUpperCase())) : data;
      document.getElementById("itemCount").textContent = filtered.length;
      document.querySelector("#detailTable tbody").innerHTML = filtered.map(i=>{
        let spec = i.spec;
        if(kw){const r=new RegExp(`(${kw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');spec=spec.replace(r,'<mark class="highlight">$1</mark>');}
        return `<tr class="${i.stock<1000&&i.stock>0?'low-stock':''}">
          <td>${i.seq}</td><td>${i.type}</td><td>${spec}</td><td>${i.material||'-'}</td>
          <td class="stock">${i.stock.toLocaleString()}</td><td>${i.unit}</td>
        </tr>`;
      }).join('');
    }

    document.querySelectorAll(".tab").forEach(t=>t.onclick=()=>{
      document.querySelectorAll(".tab,.panel").forEach(e=>e.classList.remove("active"));
      t.classList.add("active");
      document.getElementById(t.dataset.tab).classList.add("active");
    });

    document.getElementById("searchInput").oninput=e=>{
      const kw=e.target.value.toLowerCase();
      if(!kw) return renderRanking();
      renderRanking(Object.values(allData).flat().filter(i=>
        i.type.toLowerCase().includes(kw)||i.spec.toLowerCase().includes(kw)||i.material.toLowerCase().includes(kw)
      ));
    };

    document.getElementById("detailSearch").oninput=e=>renderDetailTable(currentSheetData, e.target.value);

    document.getElementById("exportBtn").onclick=()=>{exportCSV(Object.values(allData).flat().filter(i=>i.stock>0).sort((a,b)=>b.stock-a.stock),"库存排行榜.csv");};
    document.getElementById("detailExportBtn").onclick=()=>{exportCSV(currentSheetData, document.getElementById("sheetSelect").value+".csv");};

    function exportCSV(items, name){
      const csv="\uFEFF排名,型号,规格,材质,现库存,单位\n"+items.map((i,idx)=>`${idx+1},${i.type},${i.spec},${i.material||'-'},${i.stock},${i.unit}`).join("\n");
      const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8;"}));a.download=name;a.click();
    }

    lucide.createIcons();
    loadData();
  </script>
</body>
</html>
