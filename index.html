<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>三诚螺纹护套实时库存大屏</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>三诚螺纹护套实时库存大屏</h1>
      <div class="update-time" id="updateTime">加载中...</div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="overview">总览大屏</button>
      <button class="tab" data-tab="ranking">库存排行榜</button>
      <button class="tab" data-tab="detail">型号明细查询</button>
    </div>

    <div id="overview" class="panel active">
      <div class="grid">
        <div class="card total">
          <div class="num" id="totalItems">0</div>
          <div class="label">总SKU数</div>
        </div>
        <div class="card total">
          <div class="num" id="totalStock">0</div>
          <div class="label">总库存件数</div>
        </div>
        <div class="card total">
          <div class="num" id="totalTypes">0</div>
          <div class="label">总型号数</div>
        </div>
        <div class="card total">
          <div class="num" id="activeTypes">0</div>
          <div class="label">有库存型号</div>
        </div>
      </div>
      <div class="charts">
        <div class="chart-box">
          <h3>各型号库存占比</h3>
          <div id="pieChart" style="height:400px;"></div>
        </div>
        <div class="chart-box">
          <h3>库存Top15规格</h3>
          <div id="barChart" style="height:400px;"></div>
        </div>
      </div>
    </div>

    <div id="ranking" class="panel">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="搜索型号或规格（如：302、M6、1215黄铜）">
        <button id="exportBtn">导出CSV</button>
      </div>
      <div id="rankingList"></div>
    </div>

    <div id="detail" class="panel">
      <div style="margin-bottom:15px;">
        <select id="sheetSelect"></select>
        <span style="margin-left:20px;color:#aaa;">共 <span id="itemCount">0</span> 条规格</span>
      </div>
      <div class="search-bar">
        <input type="text" id="detailSearch" placeholder="模糊搜索规格（如：M8、L10、1.5D）">
        <button id="detailExportBtn">导出当前型号</button>
      </div>
      <table id="detailTable">
        <thead>
          <tr>
            <th>序号</th>
            <th>型号</th>
            <th>规格</th>
            <th>材质</th>
            <th>现库存</th>
            <th>单位</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let workbook = null;
    let allData = {};

    // 安全设置文本函数
    function safeSetText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    async function loadExcel() {
      try {
        safeSetText('updateTime', '加载数据中...');
        const resp = await fetch("data.xlsx?t=" + Date.now());
        if (!resp.ok) throw new Error("文件未找到");
        
        const buffer = await resp.arrayBuffer();
        workbook = XLSX.read(buffer, { type: "array" });
        safeSetText('updateTime', "数据更新时间: " + new Date().toLocaleString('zh-CN'));
        
        parseAllSheets();
      } catch (e) {
        safeSetText('updateTime', "加载失败: " + e.message);
        console.error(e);
      }
    }

    function parseAllSheets() {
      allData = {};
      let totalStock = 0, totalItems = 0, activeTypes = 0;
      const typeMap = {};

      workbook.SheetNames.forEach(name => {
        if (["总汇","Sheet1"].includes(name) || name.includes("空白")) return;
        const sheet = workbook.Sheets[name];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
        const items = [];

        for (let i = 4; i < rows.length; i += 2) {
          const row = rows[i] || [];
          if (!row[2]) continue;

          const stock = parseInt(row[6]) || parseInt(row[7]) || parseInt(row[5]) || 0;
          const type = (row[1] || name).toString().trim();
          const item = {
            seq: row[0] || '',
            type: type,
            spec: row[2].toString().trim(),
            material: (row[3] || '').toString().trim(),
            stock: stock,
            unit: row[5] || 'pcs'
          };
          items.push(item);

          if (stock > 0) {
            totalStock += stock;
            totalItems++;
            typeMap[type] = (typeMap[type] || 0) + stock;
            if (!typeMap[type + "_f"]) { activeTypes++; typeMap[type + "_f"] = true; }
          }
        }
        if (items.length) allData[name] = items;
      });

      safeSetText('totalItems', totalItems.toLocaleString());
      safeSetText('totalStock', totalStock.toLocaleString());
      safeSetText('totalTypes', Object.keys(allData).length);
      safeSetText('activeTypes', activeTypes);

      renderPieChart(typeMap);
      renderBarChart();
      renderRanking();
      renderTypeSelect();
    }

    function renderPieChart(map) {
      const data = Object.keys(map).filter(k => !k.endsWith("_f")).map(k => ({ name: k, value: map[k] }));
      if (document.getElementById('pieChart')) {
        echarts.init(document.getElementById("pieChart")).setOption({
          tooltip: { trigger: 'item' },
          legend: { orient: 'vertical', right: 10, top: 'center', textStyle: { color: '#fff' } },
          series: [{ type: 'pie', radius: ['30%', '70%'], center: ['40%', '50%'], data }]
        });
      }
    }

    function renderBarChart() {
      const top15 = Object.values(allData).flat().filter(i => i.stock > 0).sort((a,b) => b.stock - a.stock).slice(0, 15);
      const labels = top15.map(i => i.spec.length > 20 ? i.spec.slice(0,20) + '...' : i.spec);
      if (document.getElementById('barChart')) {
        echarts.init(document.getElementById("barChart")).setOption({
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
          grid: { left: 60, right: 20, top: 40, bottom: 60 },
          xAxis: { type: 'value', axisLabel: { color: '#ccc' } },
          yAxis: { type: 'category', data: labels, axisLabel: { color: '#fff' } },
          series: [{ type: 'bar', data: top15.map(i => ({ value: i.stock, itemStyle: { color: i.stock < 1000 ? '#ff4444' : '#00d4ff' } })), label: { show: true, position: 'right', color: '#fff' } }]
        });
      }
    }

    function renderRanking(filterItems = null) {
      let items = filterItems || Object.values(allData).flat();
      items = items.filter(i => i.stock > 0).sort((a,b) => b.stock - a.stock);

      const rankingList = document.getElementById("rankingList");
      if (rankingList) {
        const html = items.slice(0, 100).map((item, idx) => {
          const isTop3 = idx < 3;
          const isLow = item.stock < 1000;
          return `
            <div class="rank-item ${isTop3 ? 'top3' : ''} ${isLow ? 'low-stock' : ''}">
              <span class="rank-num">${idx + 1}</span>
              <span class="type ${isTop3 ? 'top3-text' : ''}">${item.type}</span>
              <span class="spec ${isTop3 ? 'top3-text' : ''}">${item.spec}</span>
              <span class="material ${isTop3 ? 'top3-text' : ''}">${item.material || '-'}</span>
              <span class="stock ${isTop3 ? 'top3-text' : ''}">${item.stock.toLocaleString()}${isLow ? ' 低库存' : ''}</span>
            </div>`;
        }).join('');
        rankingList.innerHTML = html;
      }
    }

    function renderTypeSelect() {
      const select = document.getElementById("sheetSelect");
      if (select) {
        const names = Object.keys(allData).sort();
        select.innerHTML = names.map(n => `<option value="${n}">${n}（${allData[n].length}规格）</option>`).join('');
        select.onchange = () => renderDetailTable(select.value);
        renderDetailTable(names[0]);
      }
    }

    function renderDetailTable(sheetName, kw = '') {
      const data = allData[sheetName] || [];
      let filtered = data;
      if (kw.trim()) {
        filtered = data.filter(item => item.spec.toUpperCase().includes(kw.trim().toUpperCase()));
      }
      const itemCount = document.getElementById("itemCount");
      if (itemCount) itemCount.textContent = filtered.length;

      const tbody = document.querySelector("#detailTable tbody");
      if (tbody) {
        tbody.innerHTML = filtered.map(item => {
          let displaySpec = item.spec;
          if (kw) {
            const regex = new RegExp(`(${kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            displaySpec = displaySpec.replace(regex, '<mark class="highlight">$1</mark>');
          }
          return `
            <tr class="${item.stock < 1000 && item.stock > 0 ? 'low-stock' : ''}">
              <td>${item.seq}</td>
              <td>${item.type}</td>
              <td>${displaySpec}</td>
              <td>${item.material || '-'}</td>
              <td class="stock">${item.stock.toLocaleString()}</td>
              <td>${item.unit}</td>
            </tr>
          `;
        }).join('');
      }
    }

    // Tab切换
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
        tab.classList.add("active");
        const panel = document.getElementById(tab.dataset.tab);
        if (panel) panel.classList.add("active");
      });
    });

    // 搜索
    const searchInput = document.getElementById("searchInput");
    if (searchInput) {
      searchInput.addEventListener("input", e => {
        const kw = e.target.value.toLowerCase();
        if (!kw) return renderRanking();
        const filtered = Object.values(allData).flat().filter(i => 
          i.type.toLowerCase().includes(kw) || 
          i.spec.toLowerCase().includes(kw) || 
          i.material.toLowerCase().includes(kw)
        );
        renderRanking(filtered);
      });
    }

    const detailSearch = document.getElementById("detailSearch");
    if (detailSearch) {
      detailSearch.addEventListener("input", e => {
        const kw = e.target.value;
        const sheetName = document.getElementById("sheetSelect")?.value || '';
        renderDetailTable(sheetName, kw);
      });
    }

    // 导出
    const exportBtn = document.getElementById("exportBtn");
    if (exportBtn) {
      exportBtn.onclick = () => {
        const all = Object.values(allData).flat().filter(i => i.stock > 0);
        exportCSV(all, '库存排行榜.csv');
      };
    }

    const detailExportBtn = document.getElementById("detailExportBtn");
    if (detailExportBtn) {
      detailExportBtn.onclick = () => {
        const sheetName = document.getElementById("sheetSelect")?.value || '';
        const data = allData[sheetName] || [];
        exportCSV(data, `${sheetName}.csv`);
      };
    }

    function exportCSV(items, filename) {
      const headers = "排名,型号,规格,材质,现库存,单位\n";
      const rows = items.map((item, idx) => `${idx+1},${item.type},${item.spec},${item.material || '-'},${item.stock},${item.unit}`).join("\n");
      const blob = new Blob(["\uFEFF" + headers + rows], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    lucide.createIcons();
    loadExcel();
  </script>
</body>
</html>
