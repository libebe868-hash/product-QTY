<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>三诚螺纹护套实时库存大屏</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>三诚螺纹护套实时库存大屏</h1>
      <div class="update-time" id="updateTime">加载中...</div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="overview">总览大屏</button>
      <button class="tab" data-tab="ranking">库存排行榜</button>
      <button class="tab" data-tab="detail">型号明细查询</button>
    </div>

    <!-- 加载动画 -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner"></div>
      <p>库存数据加载中...</p>
    </div>

    <div id="overview" class="panel">
      <div class="grid">
        <div class="card total"><div class="num skeleton">0</div><div class="label">总SKU数</div></div>
        <div class="card total"><div class="num skeleton">0</div><div class="label">总库存件数</div></div>
        <div class="card total"><div class="num skeleton">0</div><div class="label">总型号数</div></div>
        <div class="card total"><div class="num skeleton">0</div><div class="label">有库存型号</div></div>
      </div>
      <div class="charts">
        <div class="chart-box"><h3>各型号库存占比</h3><div id="pieChart" class="skeleton-chart"></div></div>
        <div class="chart-box"><h3>库存Top15规格</h3><div id="barChart" class="skeleton-chart"></div></div>
      </div>
    </div>

    <div id="ranking" class="panel" style="display:none;">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="搜索型号或规格（如：302、M6、1215黄铜）">
        <button id="exportBtn">导出CSV</button>
      </div>
      <div id="rankingList" class="skeleton-list"></div>
    </div>

    <div id="detail" class="panel" style="display:none;">
      <div style="margin-bottom:15px;">
        <select id="sheetSelect"><option>加载中...</option></select>
        <span style="margin-left:20px;color:#aaa;">共 <span id="itemCount">0</span> 条规格</span>
      </div>
      <div class="search-bar">
        <input type="text" id="detailSearch" placeholder="智能搜索：M3 → M3*0.5 → M3*0.5-L6（逐步精准）">
        <button id="detailExportBtn">导出当前型号</button>
      </div>
      <table id="detailTable">
        <thead><tr><th>序号</th><th>型号</th><th>规格</th><th>材质</th><th>现库存</th><th>单位</th></tr></thead>
        <tbody class="skeleton-table"><tr><td colspan="6"></td></tr></tbody>
      </table>
    </div>
  </div>

  <script>
    let workbook = null;
    let allData = {};
    let currentSheetData = [];

    function showSkeleton() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }
    function hideSkeleton() {
      document.getElementById('loadingOverlay').style.display = 'none';
      document.querySelectorAll('.skeleton,.skeleton-chart,.skeleton-list,.skeleton-table').forEach(e => {
        e.classList.remove('skeleton','skeleton-chart','skeleton-list','skeleton-table');
      });
    }

    async function loadExcel() {
      showSkeleton();
      try {
        // 关键：直接请求 data.xlsx（你仓库根目录）
        const resp = await fetch("data.xlsx?t=" + Date.now());
        if (!resp.ok) throw new Error("文件未找到");
        
        const buffer = await resp.arrayBuffer();
        workbook = XLSX.read(buffer, { type: "array" });
        document.getElementById("updateTime").textContent = "数据更新时间: " + new Date().toLocaleString('zh-CN');
        
        await parseStatsOnly();
        await parseDetailedData();
        hideSkeleton();
      } catch (e) {
        hideSkeleton();
        alert("加载失败！请确认 data.xlsx 已上传到仓库根目录\n错误: " + e.message);
      }
    }

    async function parseStatsOnly() {
      let totalStock = 0, totalItems = 0, activeTypes = 0;
      const typeMap = {};

      for (let name of workbook.SheetNames) {
        if (["总汇","Sheet1"].includes(name) || name.includes("空白")) continue;
        const sheet = workbook.Sheets[name];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
        let count = 0;
        for (let i = 4; i < rows.length; i += 2) {
          const row = rows[i] || [];
          if (!row[2]) continue;
          const stock = parseInt(row[6]) || parseInt(row[7]) || parseInt(row[5]) || 0;
          if (stock > 0) {
            totalStock += stock;
            totalItems++;
            count++;
            const type = (row[1] || name).toString().trim();
            typeMap[type] = (typeMap[type] || 0) + stock;
            if (!typeMap[type + "_f"]) { activeTypes++; typeMap[type + "_f"] = true; }
          }
        }
        if (count > 0) allData[name] = { items: [] };
      }

      document.getElementById("totalItems").textContent = totalItems.toLocaleString();
      document.getElementById("totalStock").textContent = totalStock.toLocaleString();
      document.getElementById("totalTypes").textContent = Object.keys(allData).length;
      document.getElementById("activeTypes").textContent = activeTypes;
      renderPieChart(typeMap);
    }

    async function parseDetailedData() {
      for (let name of Object.keys(allData)) {
        const sheet = workbook.Sheets[name];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
        const items = [];
        for (let i = 4; i < rows.length; i += 2) {
          const row = rows[i] || [];
          if (!row[2]) continue;
          const stock = parseInt(row[6]) || parseInt(row[7]) || parseInt(row[5]) || 0;
          items.push({
            seq: row[0] || '',
            type: (row[1] || name).toString().trim(),
            spec: row[2].toString().trim(),
            material: (row[3] || '').toString().trim(),
            stock: stock,
            unit: row[5] || 'pcs'
          });
        }
        allData[name].items = items;
        await new Promise(r => setTimeout(r, 0));
      }
      renderBarChart();
      renderRanking();
      renderTypeSelect();
    }

    function renderPieChart(map) {
      const data = Object.keys(map).filter(k => !k.endsWith("_f")).map(k => ({ name: k, value: map[k] }));
      echarts.init(document.getElementById("pieChart")).setOption({
        tooltip: { trigger: 'item' },
        legend: { orient: 'vertical', right: 10, top: 'center', textStyle: { color: '#fff' } },
        series: [{ type: 'pie', radius: ['30%', '70%'], center: ['40%', '50%'], data }]
      });
    }

    function renderBarChart() {
      const top15 = Object.values(allData).flatMap(d => d.items).filter(i => i.stock > 0).sort((a,b) => b.stock - a.stock).slice(0,15);
      const labels = top15.map(i => i.spec.length > 20 ? i.spec.slice(0,20)+'...' : i.spec);
      echarts.init(document.getElementById("barChart")).setOption({
        tooltip: { trigger: 'axis' },
        grid: { left: 60, right: 20, top: 40, bottom: 60 },
        xAxis: { type: 'value', axisLabel: { color: '#ccc' } },
        yAxis: { type: 'category', data: labels, axisLabel: { color: '#fff' } },
        series: [{ type: 'bar', data: top15.map(i => ({ value: i.stock, itemStyle: { color: i.stock < 1000 ? '#ff4444' : '#00d4ff' } })), label: { show: true, position: 'right', color: '#fff' } }]
      });
    }

    function renderRanking(items = null) {
      let list = items || Object.values(allData).flatMap(d => d.items).filter(i => i.stock > 0).sort((a,b) => b.stock - a.stock);
      document.getElementById("rankingList").innerHTML = list.slice(0,100).map((item, i) => `
        <div class="rank-item ${i<3?'top3':''} ${item.stock<1000?'low-stock':''}">
          <span class="rank-num">${i+1}</span>
          <span class="type">${item.type}</span>
          <span class="spec">${item.spec}</span>
          <span class="material">${item.material||'-'}</span>
          <span class="stock">${item.stock.toLocaleString()}${item.stock<1000?' 低库存':''}</span>
        </div>
      `).join('');
    }

    function renderTypeSelect() {
      const select = document.getElementById("sheetSelect");
      const keys = Object.keys(allData).sort();
      select.innerHTML = keys.map(k => `<option value="${k}">${k}（${allData[k].items.length}规格）</option>`).join('');
      currentSheetData = allData[keys[0]]?.items || [];
      renderDetailTable(currentSheetData);
      select.onchange = () => {
        currentSheetData = allData[select.value]?.items || [];
        renderDetailTable(currentSheetData, document.getElementById("detailSearch").value);
      };
    }

    function renderDetailTable(data, kw = '') {
      let filtered = data;
      if (kw) filtered = data.filter(i => i.spec.toUpperCase().includes(kw.toUpperCase()));
      document.getElementById("itemCount").textContent = filtered.length;

      const tbody = document.querySelector("#detailTable tbody");
      tbody.innerHTML = filtered.map(item => {
        let spec = item.spec;
        if (kw) {
          const regex = new RegExp(`(${kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
          spec = spec.replace(regex, '<mark class="highlight">$1</mark>');
        }
        return `<tr class="${item.stock<1000&&item.stock>0?'low-stock':''}">
          <td>${item.seq}</td><td>${item.type}</td><td>${spec}</td><td>${item.material}</td>
          <td class="stock">${item.stock.toLocaleString()}</td><td>${item.unit}</td>
        </tr>`;
      }).join('');
    }

    document.querySelectorAll(".tab").forEach(t => t.onclick = () => {
      document.querySelectorAll(".tab,.panel").forEach(e => e.classList.remove("active"));
      t.classList.add("active");
      document.getElementById(t.dataset.tab).classList.add("active");
    });

    document.getElementById("searchInput").oninput = e => {
      const kw = e.target.value.toLowerCase();
      if (!kw) return renderRanking();
      renderRanking(Object.values(allData).flatMap(d => d.items).filter(i =>
        i.type.toLowerCase().includes(kw) || i.spec.toLowerCase().includes(kw) || i.material.toLowerCase().includes(kw)
      ));
    };

    document.getElementById("detailSearch").oninput = e => renderDetailTable(currentSheetData, e.target.value);

    document.getElementById("exportBtn").onclick = () => exportCSV(Object.values(allData).flatMap(d=>d.items).filter(i=>i.stock>0).sort((a,b)=>b.stock-a.stock), "库存排行榜.csv");
    document.getElementById("detailExportBtn").onclick = () => exportCSV(currentSheetData, document.getElementById("sheetSelect").value + ".csv");

    function exportCSV(items, name) {
      const csv = "\uFEFF排名,型号,规格,材质,现库存,单位\n" + items.map((i,idx) => `${idx+1},${i.type},${i.spec},${i.material||'-'},${i.stock},${i.unit}`).join("\n");
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([csv], {type: "text/csv;charset=utf-8;"}));
      a.download = name;
      a.click();
    }

    lucide.createIcons();
    loadExcel();
  </script>
</body>
</html>
